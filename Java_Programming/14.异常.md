# 异常

在编程过程中，异常是指程序运行中发生的**不正常事件**，这会**中断程序的正常执行**。当异常发生时，我们应该预先设定处理异常的方法，这样程序可以在异常出现后继续运行。

# `try-catch-finally`

Java 提供了 5 个关键字来处理异常：`try`、`catch`、`finally`、`throw`、`throws`。

- `try`：用于执行可能发生异常的代码块。
- `catch`：用于捕获并处理异常。
- `finally`：无论是否发生异常，总是执行的代码块（通常用于资源释放）。
- `throw`：手动抛出异常。
- `throws`：声明该方法可能抛出的异常。

```java
try {
    // 可能发生异常的代码
} catch (异常类型 ex) {
    // 处理异常的代码
} finally {
    // 总是执行的代码
}
```

1. `try` 块无异常：不执行 `catch`，直接执行 `finally`。
2. `try` 块有异常：执行 `catch`，然后执行 `finally`。
3. `finally` 块通常用于释放资源，不管是否发生异常，都会执行。

---

## 示例：除 0 异常

我们不能将数字除以 0，以下示例展示了如何处理此类异常。

```java
package scu.test_2024_10_2.package_23_53;

import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner input = new Scanner(System.in);
        System.out.println("Enter n1: ");
        int n1 = input.nextInt();
        System.out.println("Enter n2: ");
        int n2 = input.nextInt();
        try {
            int res = n1 / n2;
            System.out.println(res);
        } catch (ArithmeticException ex) {
            System.err.println("除数不能为 0");
        } finally {
            System.out.println("程序结束");
        }
    }
}
```

# 异常对象的常用方法

- `printStackTrace()`：输出异常的堆栈信息，显示异常的类型、引发异常的代码位置等。
- `getMessage()`：返回异常的描述信息。

---

## 示例：使用 `printStackTrace()`

```java
package scu.test_2024_10_2.package_23_53;

import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner input = new Scanner(System.in);
        System.out.println("Enter n1: ");
        int n1 = input.nextInt();
        System.out.println("Enter n2: ");
        int n2 = input.nextInt();
        try {
            int res = n1 / n2;
            System.out.println(res);
        } catch (ArithmeticException ex) {
            System.err.println("除数不能为 0");
            ex.printStackTrace();
            System.out.println(ex.getMessage());
        } finally {
            System.out.println("程序结束");
        }
    }
}
```

# `finally` 与 `return`

即使在 `catch` 中有 `return`，`finally` 块中的代码依然会被执行。

```java
try {
    // 代码块 1
    return;
} catch (Exception ex) {
    return;
} finally {
    System.out.println("finally 代码块");
}
```

# 多路异常捕获

在一个 `try-catch` 语句中可以捕获多个异常。注意，异常捕获的顺序应该是从子类到父类。

---

## 多路异常捕获示例

```java
package scu.test_2024_10_3.package_12_34;

import java.util.InputMismatchException;
import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner input = new Scanner(System.in);
        try {
            System.out.println("Enter n1: ");
            int n1 = input.nextInt();
            System.out.println("Enter n2: ");
            int n2 = input.nextInt();
            int res = n1 / n2;
            System.out.println(res);
        } catch (InputMismatchException ex) {
            System.out.println("输入必须是整数");
        } catch (ArithmeticException ex) {
            System.out.println("除数不能为 0");
        } catch (Exception ex) {
            System.out.println("未知异常");
        } finally {
            System.out.println("程序结束");
        }
    }
}
```

1. 按照从子类到父类的顺序进行异常捕获。
2. 发生异常时，只会执行第一个匹配的 `catch` 块。

# `throws` 声明异常

如果一个方法内部抛出了异常，可以通过 `throws` 将异常抛给调用方处理。

```java
package scu.test_2024_10_3.package_13_09;

public class Main {
    public static void test() throws ArithmeticException {
        System.out.println(5 / 0);
    }

    public static void main(String[] args) {
        try {
            test();
        } catch (ArithmeticException e) {
            System.out.println("除数不能为 0");
        }
    }
}
```

# `throw` 抛出异常

`throw` 用于手动抛出异常。

```java
package scu.test_2024_10_3.package_13_35;

public class Main {
    public static void divide(int a, int b) {
        if (b == 0) {
            throw new ArithmeticException("除数不能为 0");
        }
        System.out.println("结果为：" + a / b);
    }

    public static void main(String[] args) {
        divide(4, 0);
    }
}
```

# 异常分类

![异常分类](https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20241003141946736.png)

- **运行时异常（RuntimeException）：**在运行时可能发生，但不强制要求处理。
- **检查时异常：**在编译时必须处理的异常，强制要求使用 `try-catch` 或 `throws`。

# 自定义异常

Java 允许我们定义自己的异常类来处理特定的异常情况。

- 自定义异常类应继承 `Exception` 或 `RuntimeException`。
- 在需要抛出自定义异常时，使用 `throw`。

---

## 自定义异常示例

```java
package scu.test_2024_10_3.package_14_50;

class AgeException extends Exception {
    public AgeException(String msg) {
        super(msg);
    }
}

public class Main {
    public static void main(String[] args) {
        Scanner input = new Scanner(System.in);
        System.out.println("请输入姓名：");
        String name = input.next();
        System.out.println("请输入年龄：");
        try {
            int age = input.nextInt();
            if (age < 0) {
                throw new AgeException("年龄不能为负数");
            }
            System.out.println("姓名：" + name);
            System.out.println("年龄：" + age);
        } catch (AgeException e) {
            System.out.println(e.getMessage());
        }
    }
}
```

# `log4j` 日志记录

`log4j` 是一个用于记录日志的开源工具，它可以帮助我们记录程序中的信息，并可以控制日志的输出格式和级别。

---

**日志级别：**

`OFF`、`FATAL`、`ERROR`、`WARN`、`INFO`、`DEBUG`、`TRACE`、`ALL`。

# 练习：方法异常处理

### 方法 A 调用方法 B，而方法 B 中出现了异常。

#### 方式一：声明异常

```java
public void methodA() throws Exception {
    methodB();
}

public void methodB() throws Exception {
    throw new Exception("异常");
}
```

#### 方式二：捕获异常

```java
public void methodA() {
    try {
        methodB();
    } catch (Exception e) {
        System.out.println(e.getMessage());
    }
}

public void methodB() throws Exception {
    throw new Exception("异常");
}
```
